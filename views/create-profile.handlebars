{{>nav}}
<link href="https://cdn.jsdelivr.net/npm/smartwizard@5/dist/css/smart_wizard_all.min.css" rel="stylesheet" type="text/css" />
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-beta.1/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/smartwizard@5/dist/js/jquery.smartWizard.min.js" type="text/javascript"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-beta.1/dist/js/select2.min.js"></script>


<style>
    .delete-selection {
        cursor: pointer;
        float: right;
        color: red;
        font-weight: bold;
    }

    .instrument-selection-item{
        padding: 10px;
        margin-bottom: 10px;
        background-color: lightyellow;
    }
</style>


<script type="text/javascript">

    //when passed an instrument id + name, will add a new section under the instrument select so the user can select level or delete.
    function addSelection(id, inst) {
        var selectionDiv = $("#instrument-selection"); //grab section below instrument select 
        selectionDiv.append("<div class='instrument-selection-item' id='" + id + "'></div>"); //add a new 'box' for this selected instrument

        var thisSelection = selectionDiv.find("#" + id); 

        thisSelection.append("<div class='delete-selection'>X</div>"); //add the icon to delete this section
        var levelSelect = $("#level-list-main").clone(); //copy the existing level selector so this instrument can have its own
        levelSelect.attr("id", "#level-" + id); //set the id for the level select + unhide it
        levelSelect.css("display", "block");

        thisSelection.append("<div class='instrument-selection-text'>" + inst + "</div>");
        thisSelection.append(levelSelect);

        $("#smartwizard").find(".tab-content").css("height", "auto"); //resize wizard container. Weird hack bc the autoAdjustHeight option isn't working for the smartWizard
    }


    $(document).ready(function () {

        //set up the instrument to use select2 for easy searching+selecting. This seemed closest to the datalist we were using
        $('#instrument-list').select2({
            placeholder: "Select an instrument"
        }).on('select2:select', function (e) {
            //whenever we select a new instrument, add it to the section below to select level
            var selectedOption = $("#instrument-list").select2('data')[0];
            addSelection(selectedOption.id, (selectedOption.text));
        });

        // SmartWizard initialize
        $('#smartwizard').smartWizard({
            justified: true, // Nav menu justification. true/false
            autoAdjustHeight: true, // Automatically adjust content height, [THIS DOESNT WORK LOL]
            showNextButton: false, // show/hide a Next button
            showPreviousButton: false, // show/hide a Previous button
        });

        //click event to remove selected instruments.
        $("body").on("click", ".delete-selection", function () {
            $(this).parent().remove();
        });

        //on button click to move from 1st to 2nd section
        $("#step-1-finish").click(function (e) {
            e.preventDefault();

            //get all selected instruments
            var selectedInstruments = $(".instrument-selection-item");

            //make sure the user chose at least one
            if (selectedInstruments.length < 1) { 
                $("#error-msg").html("Please select at least one instrument");
                $('#error-modal').foundation('open');
            }
            else {

                //gather IDs + make sure levels are all selected
                var errorMsg = ""; //this will be non-blank if we find an error
                var selected = [];

                selectedInstruments.each(function () {
                    var instID = $(this).attr("id"); //get the instrument ID
                    var levelID = $(this).find("select.selection-level").val(); //get the levelID

                    if (levelID < 1) { //this instrument doesnt have a level selected
                        errorMsg = "Please select an experience level for each instrument";
                        return false;
                    }
                    else selected.push([instID, levelID]); //add the ids to our data array
                });

                if (errorMsg != "") { //if we found an error, show it
                    
                    $("#error-msg").html(errorMsg);
                    $('#error-modal').foundation('open');
                }
                else {
                    //transfer over selected ids to hidden inputs in create form
                    $("#instrument-selections").html("");
                    $.each(selected, function (i, vals) {
                        $("#instrument-selections").append("<input type='text' name='InstrumentID-" + i + "' value='" + vals[0] + "'>");
                        $("#instrument-selections").append("<input type='text' name='LevelID-" + i + "' value='" + vals[1] + "'>");
                    });

                    $('#smartwizard').smartWizard("stepstate", [1,2], "enable");
                    $('#smartwizard').smartWizard("next"); //if all is good, go to next step

                }
            }
        });

        //move on to step 3.. TODO after we add work samples
        $("#step-2-finish").click(function (e) {
            e.preventDefault();
            $('#smartwizard').smartWizard("stepState", [2], "enable");
            $('#smartwizard').smartWizard("goToStep", 2); //if all is good, go to next step
        });


    });

</script>
<main>
    <div class="main-container">
        <div class="create-profile-header">
            <h1>Welcome to the club, {{user.FirstName}}!</h1>
            <p>You're on your way to connect with other awesome musicians like yourself!</p>
            <p>Let's find out a little bit more about you first.</p>
        </div>
        <div id="smartwizard" style="border: none;">
            <ul class="nav" style="margin-left: 0">
                <li>
                    <a class="nav-link" href="#step-1">
                        Step 1: Instruments
                    </a>
                </li>
                <li>
                    <a class="nav-link" href="#step-2">
                        Step 2: Samples
                    </a>
                </li>
                <li>
                    <a class="nav-link" href="#step-3">
                        Step 3: Basic Info
                    </a>
                </li>
            </ul>

            <div class="tab-content">
                <div id="step-1" class="tab-pane" role="tabpanel">
                    <h3>Step 1: Instruments</h3>
                    <table>
                        <tr>
                            <td>
                                <label for="instruments">
                                    What instrument(s) do you play?
                                </label>
                            </td>
                        </tr>
                        <tr>
                            <td>
                                <!--<input placeholder="Select an Instrument" list="instrument-list" type="text" id="instruments" oninput="checkSelected()">-->
                                <select id="instrument-list">
                                    <option></option>
                                    {{#each instruments}}
                                    <option value="{{this.InstrumentKey}}">{{this.Instrument}}</option>
                                    {{/each}}
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <td>
                                <div id="instrument-selection">
                                    <select id="level-list-main" class="selection-level" style="display: none">
                                        {{#each levels}}
                                        <option value="{{this.LevelKey}}">{{this.Level}}</option>
                                        {{/each}}
                                    </select>
                                </div>
                            </td>
                        </tr>
                    </table>
                    <div class="toolbar toolbar-bottom" role="toolbar" style="text-align: right;">
                        <button class="button success" type="button" id="step-1-finish">Next</button>
                    </div>
                </div>
                <div id="step-2" class="tab-pane" role="tabpanel">
                    We will add this next sprint! Just continue on for now...
                    <div class="toolbar toolbar-bottom" role="toolbar" style="text-align: right;">
                        <button class="button success" type="button" id="step-2-finish">Next</button>
                    </div>
                </div>
                <div id="step-3" class="tab-pane" role="tabpanel">
                    <h3>Step 3: Basic Info</h3>
                    <form method="post" action="/profile/basic/create">

                        <table>
                            <tr>
                                <td>
                                    <label for="ArtistName">
                                        What is your band or artist name?
                                    </label>
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    <input placeholder="Band or artist name" type="text" id="ArtistName" name="ArtistName">
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    <label for="zipCode">
                                        What is your zip code?
                                    </label>
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    <input placeholder="Zip code" type="text" pattern="[0-9]{5}" id="zipCode" name="zipCode" required>
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    <label for="phoneNumber">
                                        What is the best phone number to reach you at?
                                    </label>
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    <input placeholder="Phone number" type="number" id="phoneNumber" name="phoneNumber" required>
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    <label for="webAddress">
                                        Do you have a website?
                                    </label>
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    <input placeholder="Website URL" type="text" id="webAddress" name="webAddress">
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    <label>
                                        Are you currently looking for a spot in a band?
                                    </label>
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    <input type="radio" id="yesLooking" name="lookingForWork" value="1" checked>
                                    <label for="yesLooking">Yes</label>
                                    <input type="radio" id="notLooking" name="lookingForWork" value="0">
                                    <label for="notLooking">No</label>
                                </td>
                            </tr>
                        </table>
                        <div id="instrument-selections" style="display:none"></div>
                        <div class="create-profile">
                            <button class="button success large expanded" id="createProfileButton" type="submit">Create Your Profile</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div id="error-modal" class="reveal" data-reveal>
            <h2 id="modalTitle">Error</h2>
            <p id="error-msg" class="lead"></p>
            <button class="close-button" data-close aria-label="Close modal" type="button">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>

    </div>
</main>

